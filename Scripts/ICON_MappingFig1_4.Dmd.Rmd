---
title: "ICON_Mapping"
author: "Bre Rivera Waterman"
date: "2023-09-22"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mapping R file


 - import libraries

```{r}
library(tidyverse)
library(colourpicker)
library(lubridate)

library(sf)
library(ggspatial)
library(spData)
library(rnaturalearth)
library(rnaturalearthdata)


getwd()
#setwd("C:/Users/b923w423/Documents/GitHub/ICON-ModEx_Open_Manuscript/")

```


- Loading metadata files & binding rows 
```{r}
metadata1 <- read.csv("C:/Users/b923w423/Documents/GitHub/ICON-ModEx_Open_Manuscript/v8_WHONDRS_S19S_Sediment/WHONDRS_S19S_Sediment_Metadata/v4_WHONDRS_S19S_Metadata.csv") %>% slice(-1) %>% 
                                                                dplyr::select(lat = "MS_Latitude_dec.deg",
                                                                long = "MS_Longitude_dec.deg",
                                                                "Date",
                                                                site_ID = "Sample_ID",
                                                                site_name = "Stream_Name",
                                                                Agency = "Associated_Site",
                                                                state = "State_or_Province", 
                                                                Country = "Country") %>%
                                                                 mutate(site_ac = "no")
metadata2 <- read.csv("C:/Users/b923w423/Documents/GitHub/ICON-ModEx_Open_Manuscript/v3_CM_SSS_Data_Package/v3_CM_SSS_Field_Metadata.csv", header = TRUE) %>%      mutate(Country = "USA")  %>%                                 
                                                                dplyr::select(lat = "Sample_Latitude",
                                                                long = "Sample_Longitude",
                                                                Date = "Sample_Date",
                                                                site_ID = "Parent_ID",
                                                                site_name = "Stream_Name",
                                                                Agency = "Organization",
                                                                state = "State",
                                                                 "Country",
                                                                site_ac = "Site_ID")
                                                               
                                                            


combo_metadata <- rbind(metadata1,metadata2) %>%  #combining datasets
   filter(Country == "USA", state != "Puerto Rico", state !="Alaska") %>% #next few lines are to determine which sites are NEON, create a time series Y or N column based on if sites are NEON
   mutate(Date_whole = ymd(Date), Year = year(Date),
          lat = as.numeric(lat), long = as.numeric(long),
  Time_series = case_when(
    str_detect(site_ac, "HOPB|MAYF|MART") ~"Yes", 
    TRUE ~ "No"),
#create season col based on months
   season = case_when(
   month(Date) %in% c(3,4,5) ~ "Spring", 
   month(Date) %in% c(6,7,8) ~ "Summer", 
   month(Date) %in% c(9,10,11) ~ "Fall", 
   TRUE ~ "Winter", 
))


```



## Fig 1; seasonal map with time series site different shape
```{r}

usa <- st_as_sf(maps::map("state", fill=TRUE, plot =FALSE))

ggplot(usa) +
  geom_sf(color = "#2b2b2b", fill = "white", size=0.125) +
  coord_sf(crs = st_crs("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"), datum = NA) +
  #geom_spatial_point(data=combo_metadata, aes(x=long,y=lat, fill = season),  pch = 21, size = 4) +  
   geom_spatial_point(data=combo_metadata, aes(x=long,y=lat, fill = season, shape = Time_series, size = Time_series)) + 

  scale_fill_manual(values =  c("#8c510a","#dfc27d", "#c7eae5", "#01665e" ))+ #color blind safe colors
  #scale_color_manual(values =  c("#8B2252", "#EE799F", "#4d9221", "#e6f5d0" ))+ #color blind safe colors
  scale_shape_manual(values = c(21, 15)) + 
  scale_size_manual(values = c(4, 6)) +
  ylab("Latitude") + 
  xlab("Longitude") + 
  theme_classic()


```
 
  - needs scale bar
  - pretty basic map, gets the point across but could be improved and open to suggestions!
  - interactive map tutorial linked here: http://maxpohlman.com/rgistutorial


## Scatter plot  
- using new merged dataset to create scatter plot
```{r}
combods <- read.csv("C:/Users/b923w423/Documents/GitHub/ICON-ModEx_Open_Manuscript/ICON-ModEx_Combined_Predicted_Observed_Respiration_Rates.csv") %>% filter(!is.na(Observed_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment),!is.na(Predicted_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment)) %>% filter(Observed_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment > -9990, Predicted_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment > -9990 )

#scatter plot
combods %>% ggplot(aes(abs(Predicted_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment), abs(Observed_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment))) +
  geom_point() + 
    geom_abline (slope=1, linetype = "dashed", color="Red") + 
    stat_poly_line(color = "light grey", alpha = 0.01) +
  stat_poly_eq(use_label(c( "R2"))) +
  ylab("Observed rates") + 
  xlab("Predicted rates") + 
    lims(y = c(0,4000), x = c(0,4000)) + 
  theme_classic()


#trying to get log rates to fully plot
combods %>% 
  ggplot() +
  geom_point(aes(log(-Predicted_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment+10),log(-Observed_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment+10) )) + 
  geom_abline (slope=1, linetype = "dashed", color="Red") + 
  ylab("log(Observed rates + 10)") + 
  xlab("log(Predicted rates + 10)") + 
  #lims(y = c(4,10), x = c(4,10)) + 
  theme_classic()


```
 
  - add units to axis?
  - increase text size



## Fig 4 
```{r}
combods <- combods %>% filter(Latitude < 50 & Latitude > 20) %>% mutate(LogObs = Observed_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment, LogPred = Predicted_Normalized_Respiration_Rate_mg_DO_per_H_per_L_sediment)

library(RColorBrewer)


Obs <- ggplot(usa) +
  geom_sf(color = "#2b2b2b", fill = "white", size=0.125) +
  coord_sf(crs = st_crs("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"), datum = NA) +
  geom_spatial_point(data=combods, aes(x=Longitude,y=Latitude, fill = log(-LogObs+10)), pch = 21, size =3) +     
  #scale_shape_manual(values = c(16, 8)) +
   # scale_size_manual(values = c(4, 8)) +
  scale_fill_distiller(palette = "Oranges", direction = 1,  
                        limits = c(min(log(0+10)), max(log(4000+10)) )) + 
  ylab("Latitude") + 
  xlab("Longitude") +
  theme_classic()

  
 Pred<- 
  ggplot(usa) +
  geom_sf(color = "#2b2b2b", fill = "white", size=0.125) +
  coord_sf(crs = st_crs("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"), datum = NA) +
  geom_spatial_point(data=combods, aes(x=Longitude,y=Latitude, fill = log(-LogPred+10)), pch = 21, size =3) +     
  #scale_shape_manual(values = c(16, 8)) +
   # scale_size_manual(values = c(4, 8)) +
  scale_fill_distiller( palette = "Oranges", direction = 1, 
                        limits = c(min(log(0+10)), max(log(4000+10)) ) )  + 
  ylab("Latitude") + 
  xlab("Longitude")  +
  theme_classic() 



  Obs / Pred

```

- need to rename column/remove redundant "log"
